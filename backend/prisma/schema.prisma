// Prisma Schema - OT2net
// Conectado ao Supabase PostgreSQL
// Schema completo baseado em plan.md e tabelas existentes no Supabase

generator client {
  provider = "prisma-client-js"
}

// Configuração do seed
// Executar com: npm run prisma:seed

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ============================================
// Cliente e Organização
// ============================================

model Cliente {
  id                  String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  razao_social        String    @db.Text
  cnpj                String    @unique @db.Text
  endereco            Json?     @db.JsonB
  contatos            Json?     @db.JsonB
  classificacao       String?   @db.Text
  estrutura           Json?     @db.JsonB
  agencias_reguladoras String[] @db.Text
  certificacoes       String[]  @db.Text
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)

  empresas            Empresa[]
  projetos            Projeto[]
  usuarios            Usuario[]

  @@index([cnpj])
  @@index([created_at])
  @@map("clientes")
}

model Empresa {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  cliente_id            String?   @db.Uuid
  identificacao         String    @db.Text
  tipo                  String?   @db.Text
  participacao_acionaria String?  @db.Text
  ambito_operacional    String?   @db.Text
  contexto_operacional  String?   @db.Text
  status                String?   @db.Text
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)

  cliente               Cliente?  @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  sites                 Site[]

  @@index([cliente_id])
  @@index([status])
  @@map("empresas")
}

model Site {
  id                        String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  empresa_id                String?   @db.Uuid
  identificacao             String    @db.Text
  classificacao             String?   @db.Text
  criticidade_operacional   String?   @db.Text
  localizacao_geografica    Json?     @db.JsonB
  infraestrutura_comunicacao Json?    @db.JsonB
  sistemas_principais       String[]  @db.Text
  responsaveis              Json?     @db.JsonB
  seguranca_fisica          Json?     @db.JsonB
  created_at                DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                DateTime? @default(now()) @db.Timestamptz(6)

  empresa                   Empresa?  @relation(fields: [empresa_id], references: [id], onDelete: Cascade)
  ativos                    Ativo[]
  descricoes_operacionais_raw DescricaoOperacionalRaw[]
  riscos                    Risco[]

  @@index([empresa_id])
  @@index([classificacao])
  @@map("sites")
}

// ============================================
// Projeto e Fases
// ============================================

model Projeto {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  cliente_id      String?   @db.Uuid
  nome            String    @db.Text
  descricao       String?   @db.Text
  fase_atual      String?   @default("fase-1") @db.Text
  progresso_geral Float?    @default(0)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  cliente         Cliente?  @relation(fields: [cliente_id], references: [id], onDelete: Cascade)
  membros_equipe  MembroEquipe[]
  iniciativas     Iniciativa[]
  descricoes_operacionais_raw DescricaoOperacionalRaw[]
  questionarios   Questionario[]
  stakeholders    Stakeholder[]
  riscos          Risco[]

  @@index([cliente_id])
  @@index([fase_atual])
  @@index([created_at])
  @@map("projetos")
}

model MembroEquipe {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id      String?   @db.Uuid
  usuario_id      String?   @db.Uuid
  papel           String?   @db.Text
  responsabilidade String?  @db.Text
  autoridade      String?   @db.Text
  consultado      String?   @db.Text
  informado       String?   @db.Text
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  projeto         Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)

  @@index([projeto_id])
  @@index([usuario_id])
  @@map("membros_equipe")
}

model Stakeholder {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id            String?   @db.Uuid
  identificacao_pessoal Json?     @db.JsonB
  vinculo_profissional  Json?     @db.JsonB
  contatos              Json?     @db.JsonB
  localizacao           String?   @db.Text
  papel_no_projeto      String?   @db.Text
  poder_influencia      String?   @db.Text
  expertise             String?   @db.Text
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)

  projeto               Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)

  @@index([projeto_id])
  @@map("stakeholders")
}

// ============================================
// Fase 0 - Descoberta
// ============================================

model DescricaoOperacionalRaw {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id            String?   @db.Uuid
  titulo                String    @db.Text
  descricao_completa    String    @db.Text
  frequencia            String?   @db.Text
  impacto               String?   @db.Text
  dificuldades          String?   @db.Text
  pessoa_id             String?   @db.Uuid
  site_id               String?   @db.Uuid
  cargo                 String?   @db.Text
  turno                 String?   @db.Text
  data_coleta           DateTime? @default(now()) @db.Timestamptz(6)
  metodo_coleta         String?   @db.Text
  status_processamento  String?   @default("pendente") @db.Text
  resultado_processamento Json?   @db.JsonB
  score_qualidade       Float?
  processado_por_ia     Boolean?  @default(false) @db.Boolean
  revisado_por_id       String?   @db.Uuid
  created_at            DateTime? @default(now()) @db.Timestamptz(6)
  updated_at            DateTime? @default(now()) @db.Timestamptz(6)

  projeto               Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)
  site                  Site?     @relation(fields: [site_id], references: [id], onDelete: SetNull)
  processo_normalizado  ProcessoNormalizado?

  @@index([projeto_id])
  @@index([site_id])
  @@index([status_processamento])
  @@index([data_coleta])
  @@index([processado_por_ia])
  @@map("descricoes_operacionais_raw")
}

model ProcessoNormalizado {
  id                        String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  descricao_raw_id          String?   @unique @db.Uuid
  nome                      String    @db.Text
  objetivo                  String?   @db.Text
  gatilho                   String?   @db.Text
  frequencia                String?   @db.Text
  duracao_estimada          String?   @db.Text
  criticidade               String?   @db.Text
  dependencias              String[]  @db.Text
  observacoes_gerais        String?   @db.Text
  nivel_confianca_normalizacao Float?
  tipo_processo             String?   @db.Text
  status                    String?   @default("pendente") @db.Text
  versao                    Int?      @default(1)
  created_at                DateTime? @default(now()) @db.Timestamptz(6)
  updated_at                DateTime? @default(now()) @db.Timestamptz(6)

  descricao_raw             DescricaoOperacionalRaw? @relation(fields: [descricao_raw_id], references: [id], onDelete: Cascade)
  etapas                    ProcessoEtapa[]
  ativos                    Ativo[]
  dificuldades              DificuldadeOperacional[]
  workarounds               Workaround[]
  riscos                    Risco[]

  @@index([descricao_raw_id])
  @@index([status])
  @@index([tipo_processo])
  @@index([created_at])
  @@map("processos_normalizados")
}

model ProcessoEtapa {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  processo_normalizado_id String? @db.Uuid
  ordem                 Int
  nome                  String    @db.Text
  descricao             String    @db.Text
  tipo_etapa            String?   @db.Text
  sistemas_envolvidos   String[]  @db.Text
  ativos_envolvidos     String[]  @db.Text
  tempo_estimado        String?   @db.Text
  created_at            DateTime? @default(now()) @db.Timestamptz(6)

  processo_normalizado  ProcessoNormalizado? @relation(fields: [processo_normalizado_id], references: [id], onDelete: Cascade)

  @@index([processo_normalizado_id, ordem])
  @@map("processo_etapas")
}

model Ativo {
  id                      String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  site_id                 String?   @db.Uuid
  processo_normalizado_id String?   @db.Uuid
  tipo                    String    @db.Text
  nome                    String    @db.Text
  categoria               String?   @db.Text
  localizacao             String?   @db.Text
  criticidade             String?   @db.Text
  caracteristicas_tecnicas Json?    @db.JsonB
  rede_conectividade      String?   @db.Text
  protocolos              String[]  @db.Text
  seguranca               Json?     @db.JsonB
  lifecycle               Json?     @db.JsonB
  documentacao            Json?     @db.JsonB
  conformidade            Json?     @db.JsonB
  created_at              DateTime? @default(now()) @db.Timestamptz(6)
  updated_at              DateTime? @default(now()) @db.Timestamptz(6)

  site                    Site?     @relation(fields: [site_id], references: [id], onDelete: SetNull)
  processo_normalizado    ProcessoNormalizado? @relation(fields: [processo_normalizado_id], references: [id], onDelete: SetNull)
  riscos                  Risco[]

  @@index([site_id])
  @@index([processo_normalizado_id])
  @@index([tipo])
  @@index([categoria])
  @@map("ativos")
}

model DificuldadeOperacional {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  processo_normalizado_id String? @db.Uuid
  descricao             String    @db.Text
  categoria             String?   @db.Text
  impacto               String?   @db.Text
  frequencia            String?   @db.Text
  sistemas_afetados     String[]  @db.Text
  data_identificacao    DateTime? @default(now()) @db.Timestamptz(6)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)

  processo_normalizado  ProcessoNormalizado? @relation(fields: [processo_normalizado_id], references: [id], onDelete: Cascade)

  @@index([processo_normalizado_id])
  @@index([categoria])
  @@map("dificuldades_operacionais")
}

model Workaround {
  id                    String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  processo_normalizado_id String? @db.Uuid
  descricao             String    @db.Text
  razao                 String?   @db.Text
  risco_percebido       String?   @db.Text
  categoria             String?   @db.Text
  data_identificacao    DateTime? @default(now()) @db.Timestamptz(6)
  created_at            DateTime? @default(now()) @db.Timestamptz(6)

  processo_normalizado  ProcessoNormalizado? @relation(fields: [processo_normalizado_id], references: [id], onDelete: Cascade)

  @@index([processo_normalizado_id])
  @@index([categoria])
  @@map("workarounds")
}

// ============================================
// Questionários
// ============================================

model Questionario {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id      String?   @db.Uuid
  titulo          String    @db.Text
  descricao       String?   @db.Text
  status          String?   @default("rascunho") @db.Text
  data_criacao    DateTime? @default(now()) @db.Timestamptz(6)
  data_publicacao DateTime? @db.Timestamptz(6)
  data_fechamento DateTime? @db.Timestamptz(6)
  anonimo         Boolean?  @default(false) @db.Boolean
  link_acesso     String?   @unique @db.Text
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  projeto         Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)
  questoes        Questao[]
  respostas       RespostaQuestionario[]

  @@index([projeto_id])
  @@index([status])
  @@index([link_acesso])
  @@index([data_publicacao])
  @@map("questionarios")
}

model Questao {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  questionario_id String?   @db.Uuid
  tipo_questao    String    @db.Text
  texto_questao   String    @db.Text
  opcoes_resposta Json?     @db.JsonB
  obrigatoria     Boolean?  @default(false) @db.Boolean
  ordem           Int
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  questionario    Questionario? @relation(fields: [questionario_id], references: [id], onDelete: Cascade)
  respostas       RespostaQuestao[]

  @@index([questionario_id, ordem])
  @@index([tipo_questao])
  @@map("questoes")
}

model RespostaQuestionario {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  questionario_id String?   @db.Uuid
  respondente_id  String?   @db.Uuid
  data_preenchimento DateTime? @default(now()) @db.Timestamptz(6)
  progresso       Float?    @default(0)
  status          String?   @default("em_progresso") @db.Text
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  questionario    Questionario? @relation(fields: [questionario_id], references: [id], onDelete: Cascade)
  respostas       RespostaQuestao[]

  @@index([questionario_id])
  @@index([respondente_id])
  @@index([status])
  @@index([data_preenchimento])
  @@map("respostas_questionario")
}

model RespostaQuestao {
  id                      String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  resposta_questionario_id String?   @db.Uuid
  questao_id             String?   @db.Uuid
  resposta_texto         String?   @db.Text
  resposta_numero        Float?
  resposta_data          DateTime? @db.Date
  resposta_multipla_escolha String[] @db.Text
  resposta_escala        Int?
  resposta_arquivo_url   String?   @db.Text
  created_at             DateTime? @default(now()) @db.Timestamptz(6)

  resposta_questionario  RespostaQuestionario? @relation(fields: [resposta_questionario_id], references: [id], onDelete: Cascade)
  questao                Questao?  @relation(fields: [questao_id], references: [id], onDelete: Cascade)

  @@index([resposta_questionario_id])
  @@index([questao_id])
  @@map("respostas_questao")
}

// ============================================
// Fase 2 - Plano Diretor
// ============================================

model Iniciativa {
  id                  String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id          String?   @db.Uuid
  plano_diretor_id    String?   @db.Uuid
  nome                String    @db.Text
  descricao           String?   @db.Text
  dominio_governanca  String?   @db.Text
  status              String?   @default("planejada") @db.Text
  progresso_percentual Float?   @default(0)
  saude               String?   @default("verde") @db.Text
  responsavel_id      String?   @db.Uuid
  data_inicio         DateTime? @db.Date
  data_fim_prevista   DateTime? @db.Date
  data_fim_real       DateTime? @db.Date
  prioridade          String?   @db.Text
  custo_estimado      Float?
  beneficio_estimado  String?   @db.Text
  created_at          DateTime? @default(now()) @db.Timestamptz(6)
  updated_at          DateTime? @default(now()) @db.Timestamptz(6)

  projeto             Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)

  @@index([projeto_id])
  @@index([status])
  @@index([dominio_governanca])
  @@index([data_inicio])
  @@index([data_fim_prevista])
  @@map("iniciativas")
}

// ============================================
// Usuários e Autenticação
// ============================================

// Enum de Roles de Usuário
enum UserRole {
  ADMIN
  GERENTE_PROJETO
  CONSULTOR
  CLIENTE
  AUDITOR
}

model Usuario {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  supabase_user_id String?  @unique @db.Uuid
  nome            String    @db.Text
  email           String    @unique @db.Text
  role            UserRole  @default(CONSULTOR)
  organizacao     String?   @db.Text
  cliente_id      String?   @db.Uuid
  status          String?   @default("ativo") @db.Text
  ultimo_acesso   DateTime? @db.Timestamptz(6)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)
  updated_at      DateTime? @default(now()) @db.Timestamptz(6)

  cliente         Cliente?  @relation(fields: [cliente_id], references: [id], onDelete: SetNull)
  permissoes      Permissao[]

  @@index([email])
  @@index([supabase_user_id])
  @@index([role])
  @@index([cliente_id])
  @@index([status])
  @@map("usuarios")
}

model Permissao {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  usuario_id      String?   @db.Uuid
  entidade_tipo   String    @db.Text
  acao            String    @db.Text
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  usuario         Usuario?  @relation(fields: [usuario_id], references: [id], onDelete: Cascade)

  @@index([usuario_id])
  @@index([entidade_tipo, acao])
  @@map("permissoes")
}

// ============================================
// IA e Processamento
// ============================================

model ChamadaIA {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  funcionalidade  String    @db.Text
  tokens_input    Int?
  tokens_output   Int?
  custo           Float?
  sucesso         Boolean?  @default(true) @db.Boolean
  erro            String?   @db.Text
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  @@index([funcionalidade])
  @@index([sucesso])
  @@index([created_at])
  @@map("chamadas_ia")
}

// ============================================
// Frameworks Regulatórios Vetorizados
// ============================================

model RequisitoFramework {
  id              String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  framework       String    @db.Text
  codigo          String    @db.Text
  titulo          String    @db.Text
  descricao       String    @db.Text
  categoria       String?   @db.Text
  versao          String?   @db.Text
  embedding       Unsupported("vector(1536)") // pgvector - 1536 dimensões para Claude embeddings
  data_vetorizacao DateTime? @db.Timestamptz(6)
  created_at      DateTime? @default(now()) @db.Timestamptz(6)

  analises_conformidade AnaliseConformidade[]

  @@index([framework])
  @@index([codigo])
  @@index([categoria])
  @@index([data_vetorizacao])
  @@map("requisitos_framework")
}

model AnaliseConformidade {
  id                String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  requisito_id      String?   @db.Uuid
  entidade_tipo     String    @db.Text
  entidade_id       String    @db.Uuid
  similaridade      Float?
  status            String?   @db.Text
  evidencias        String[]  @db.Uuid
  gaps              String[]  @db.Text
  recomendacoes     String[]  @db.Text
  analisado_por_ia  Boolean?  @default(false) @db.Boolean
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  requisito         RequisitoFramework? @relation(fields: [requisito_id], references: [id], onDelete: Cascade)

  @@index([requisito_id])
  @@index([entidade_tipo, entidade_id])
  @@index([status])
  @@index([similaridade])
  @@map("analises_conformidade")
}

// ============================================
// Riscos
// ============================================

model Risco {
  id                String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  projeto_id        String?   @db.Uuid
  ativo_id          String?   @db.Uuid
  processo_id       String?   @db.Uuid
  site_id           String?   @db.Uuid
  nome              String    @db.Text
  descricao         String?   @db.Text
  classificacao     String?   @db.Text
  impacto           String?   @db.Text
  probabilidade     String?   @db.Text
  controles_existentes String? @db.Text
  data_identificacao DateTime? @default(now()) @db.Timestamptz(6)
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  projeto           Projeto?  @relation(fields: [projeto_id], references: [id], onDelete: Cascade)
  ativo             Ativo?    @relation(fields: [ativo_id], references: [id], onDelete: SetNull)
  processo          ProcessoNormalizado? @relation(fields: [processo_id], references: [id], onDelete: SetNull)
  site              Site?     @relation(fields: [site_id], references: [id], onDelete: SetNull)

  @@index([projeto_id])
  @@index([ativo_id])
  @@index([processo_id])
  @@index([site_id])
  @@index([classificacao])
  @@index([data_identificacao])
  @@map("riscos")
}

// ============================================
// Indicadores
// ============================================

model Indicador {
  id                String    @id @default(dbgenerated("extensions.uuid_generate_v4()")) @db.Uuid
  dominio_governanca String   @db.Text
  tipo              String    @db.Text
  nome              String    @db.Text
  formula           String?   @db.Text
  fonte_dados       String?   @db.Text
  baseline          Float?
  target            Float?
  threshold_verde   Float?
  threshold_amarelo Float?
  threshold_vermelho Float?
  responsavel_id    String?   @db.Uuid
  created_at        DateTime? @default(now()) @db.Timestamptz(6)
  updated_at        DateTime? @default(now()) @db.Timestamptz(6)

  @@index([dominio_governanca])
  @@index([tipo])
  @@index([responsavel_id])
  @@map("indicadores")
}
